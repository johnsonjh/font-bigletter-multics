/*
 * vim: filetype=c:tabstop=2:softtabstop=2:shiftwidth=2:ai:expandtab:cc=80:
 * SPDX-License-Identifier: Multics
 * scspell-id: 3ea168f2-9402-11f0-b0e2-80ee73e9b8e7
 * Multics: See >ldd>sss>s>bound_printing_cmds_.s.archive
 *
 * ---------------------------------------------------------------------------
 *
 * Copyright (c) 1972 Massachusetts Institute of Technology
 * Copyright (c) 1972-1982 Honeywell Information Systems, Inc.
 * Copyright (c) 2006 Bull HN Information Systems, Inc.
 * Copyright (c) 2006 Bull SAS
 * Copyright (c) 2025 Jeffrey H. Johnson
 * Copyright (c) 2025 The DPS8M Development Team
 *
 * ---------------------------------------------------------------------------
 */

/*****************************************************************************/

#include <inttypes.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

/*****************************************************************************/

static void
word_bits (const char * oct_str, int width, int * bits, int offset)
{
  uint64_t v = 0;
  int i;

  (void)sscanf (oct_str, "%" SCNo64, & v);

  for (i = 0; i < width; i++)
    {
      int shift = width - 1 - i;

      if (shift < (int)(sizeof (v) * 8))
        bits [offset + i] = (v >> shift) & 1;
      else
        bits [offset + i] = 0;
    }
}

/*****************************************************************************/

static void
glyph_bits_from_line (const char * line, int total_bits, int * bits)
{
  char line_buf [256];
  char * p;
  char * comma;

  (void)strncpy (line_buf, line, sizeof (line_buf) - 1);
  line_buf [sizeof (line_buf) - 1] = '\0';

  p = strstr (line_buf, "oct ");

  if (p)
    p += 4;
  else
    p = line_buf;

  comma = strchr (p, ',');

  if (comma)
    {
      * comma = '\0';
      word_bits (p, 36, bits, 0);
      word_bits (comma + 1, 36, bits, 36);
    }
  else
    word_bits (p, total_bits, bits, 0);
}

/*****************************************************************************/

static void
decode_table (const char * * lines, int num_lines, int glyph_width,
              int glyph_height, int total_bits)
{
  int ascii_code;
  int max_chars;
  int i;

  (void)fprintf (stdout, "{\n");

  ascii_code = 32;
  max_chars = (96 < num_lines - 1) ? 96 : num_lines - 1;

  for (i = 1; i <= max_chars; i++)
    {
      int bits [72];
      int m;
      int r;
      int c;

      glyph_bits_from_line (lines [i], total_bits, bits);

      (void)fprintf (stdout, "   \"");

      if ('\"' == ascii_code)
        (void)fprintf (stdout, "\\\"");
      else if ('\\' == ascii_code)
        (void)fprintf (stdout, "\\\\");
      else if (127 == ascii_code)
        (void)fprintf (stdout,"\\u007f");
      else
        (void)fprintf (stdout, "%c", (char)ascii_code);

      (void)fprintf (stdout, "\": [\n");

      m = 0;

      for (r = 0; r < glyph_height; r++)
        {
          (void)fprintf (stdout, "      \"");

          for (c = 0; c < glyph_width; c++)
            {
              (void)fprintf (stdout, "%c", bits [m] ? '#' : '.');
              m++;
            }

          (void)fprintf (stdout, "\"");

          if (glyph_height - 1 > r)
            (void)fprintf (stdout, ",");

          (void)fprintf (stdout, "\n");
        }

      (void)fprintf (stdout, "   ]");

      if (max_chars > i)
        (void)fprintf (stdout, ",");

      (void)fprintf (stdout, "\n");

      ascii_code++;
    }

  (void)fprintf (stdout, "}\n");
}

/*****************************************************************************/

static const char *
big_lines[] =
{
  "oct 000000000000,000000000000",
  "oct 000000000000,000000000000",
  "oct 060140300601,403000014030",
  "oct 314630000000,000000000000",
  "oct 000220447762,237711022000",
  "oct 000041766207,701337404000",
  "oct 001617460301,406031743400",
  "oct 060220440604,460641474000",
  "oct 030140000000,000000000000",
  "oct 006030140300,601403003003",
  "oct 600600601403,006014060300",
  "oct 000142312657,753246214000",
  "oct 000000300617,743006000000",
  "oct 000000000000,000030060200",
  "oct 000000000007,700000000000",
  "oct 000000000000,000030060000",
  "oct 006014060301,406030140300",
  "oct 060631463146,314631414000",
  "oct 030160140300,601403037400",
  "oct 170430030140,603014077400",
  "oct 376030140700,300301476000",
  "oct 006034170663,157700601400",
  "oct 771403007600,600643074000",
  "oct 160621403706,314631436000",
  "oct 776030140603,014030060000",
  "oct 060631460606,314631414000",
  "oct 060631461740,300611416000",
  "oct 000000003006,000030060000",
  "oct 000000003006,000030060200",
  "oct 006030140603,003003003003",
  "oct 000000003740,017600000000",
  "oct 600600600600,603014060300",
  "oct 170410020103,406014000060",
  "oct 375006355132,264547677000",
  "oct 170773036077,770360741400",
  "oct 771413027714,130360777000",
  "oct 375407006014,030060277000",
  "oct 771413036074,170360576000",
  "oct 777403007754,030060177400",
  "oct 777403007754,030060140000",
  "oct 375407006014,770360677000",
  "oct 607417037774,170360741400",
  "oct 170140300601,403006036000",
  "oct 006014030060,170360677000",
  "oct 615463307015,431461541400",
  "oct 601403006014,030060177400",
  "oct 607637336674,170360741400",
  "oct 607617236674,571761741400",
  "oct 375417036074,170360677000",
  "oct 771413027714,030060140000",
  "oct 375417036074,170362677002",
  "oct 771413027714,130360741400",
  "oct 375407003740,140340677000",
  "oct 776140300601,403006014000",
  "oct 607417036074,170360677000",
  "oct 607417036074,154617014000",
  "oct 607417036675,574760700400",
  "oct 606630740603,614660741400",
  "oct 403415461701,403006014000",
  "oct 776014060301,406030177400",
  "oct 036060140300,601403006017",
  "oct 601401401401,401401401403",
  "oct 740300601403,006014030360",
  "oct 020120000000,000000000000",
  "oct 000000000000,000000000377",
  "oct 060060000000,000000000000",
  "oct 000000003740,157760677400",
  "oct 601403007754,170360777000",
  "oct 000000003774,030060077400",
  "oct 006014033774,170360677400",
  "oct 000000003754,177660077000",
  "oct 000160607703,006014030000",
  "oct 000000003754,031760677000",
  "oct 601403007754,170360741400",
  "oct 000000300003,403006036000",
  "oct 000000300001,403006154370",
  "oct 001403146617,033063143000",
  "oct 000001700601,403006017000",
  "oct 000000005555,573366755400",
  "oct 000000005754,170360741400",
  "oct 000000003754,170360677000",
  "oct 000000007754,170377540300",
  "oct 000000003754,170337601407",
  "oct 000000005616,630060140000",
  "oct 000000003754,017600677000",
  "oct 000000303741,403006014000",
  "oct 000000006074,170360677400",
  "oct 000000006074,154617014000",
  "oct 000000006075,573371641000",
  "oct 000000006063,603017141400",
  "oct 000000006066,146607014170",
  "oct 000000003740,603014077000",
  "oct 006030140141,600603003003",
  "oct 040100200400,002004010020",
  "oct 600600603003,414014060300",
  "oct 170020000000,000000000000",
  "oct 000000000000,000000000000",
};

/*****************************************************************************/

static const char *
littles_lines[] =
{
  "oct 000000000000",
  "oct 000000000000",
  "oct 102040020000",
  "oct 240000000000",
  "oct 257527650000",
  "oct 372161370000",
  "oct 635042714000",
  "oct 212145370000",
  "oct 021000000000",
  "oct 144102030000",
  "oct 301020460000",
  "oct 112775220000",
  "oct 002371000000",
  "oct 000001440000",
  "oct 000160000000",
  "oct 000000010000",
  "oct 021042100000",
  "oct 105212420000",
  "oct 106041070000",
  "oct 311042174000",
  "oct 740560370000",
  "oct 430770204000",
  "oct 770360370000",
  "oct 164364270000",
  "oct 761042100000",
  "oct 311144460000",
  "oct 311360460000",
  "oct 000040020000",
  "oct 003001440000",
  "oct 104202020000",
  "oct 017407600000",
  "oct 101010420000",
  "oct 350421020000",
  "oct 772674174000",
  "oct 105374304000",
  "oct 750764370000",
  "oct 370204074000",
  "oct 750614370000",
  "oct 770364174000",
  "oct 770364100000",
  "oct 370274274000",
  "oct 430774304000",
  "oct 342041070000",
  "oct 020414270000",
  "oct 431304504000",
  "oct 410204174000",
  "oct 435654304000",
  "oct 434654704000",
  "oct 350614270000",
  "oct 750764100000",
  "oct 350614674000",
  "oct 750764304000",
  "oct 370160370000",
  "oct 762041020000",
  "oct 430614270000",
  "oct 430612420000",
  "oct 430656704000",
  "oct 425042504000",
  "oct 425041020000",
  "oct 761042174000",
  "oct 344102070000",
  "oct 404040404000",
  "oct 341020470000",
  "oct 042400000000",
  "oct 000000174000",
  "oct 040400000000",
  "oct 105374304000",
  "oct 750764370000",
  "oct 370204074000",
  "oct 750614370000",
  "oct 770364174000",
  "oct 770364100000",
  "oct 370274274000",
  "oct 430774304000",
  "oct 342041070000",
  "oct 020414270000",
  "oct 431304504000",
  "oct 410204174000",
  "oct 435654304000",
  "oct 434654704000",
  "oct 350614270000",
  "oct 750764100000",
  "oct 350614674000",
  "oct 750764304000",
  "oct 370160370000",
  "oct 762041020000",
  "oct 430614270000",
  "oct 430612420000",
  "oct 430656704000",
  "oct 425042504000",
  "oct 425041020000",
  "oct 761042174000",
  "oct 144302030000",
  "oct 102001020000",
  "oct 301030460000",
  "oct 341000000000",
  "oct 000000000000",
};

/*****************************************************************************/

int
main (int argc, char * argv [])
{
  const char * program_name = (argv [0] && * argv [0]) ? argv [0] : "makefont";

  if (2 == argc)
    {
      if (0 == strcmp (argv [1], "big"))
        {
          const int num_lines =
            sizeof (big_lines) / sizeof (big_lines [0]);

          decode_table (big_lines, num_lines, 8, 9, 72);

          return EXIT_SUCCESS;
        }

      if (0 == strcmp (argv [1], "little"))
        {
          const int num_lines =
            sizeof (littles_lines) / sizeof (littles_lines [0]);

          decode_table (littles_lines, num_lines, 5, 5, 36);

          return EXIT_SUCCESS;
        }
    }

  (void)fprintf (stderr, "Usage: %s [big | little]\n", program_name);

  return EXIT_FAILURE;
}

/*****************************************************************************/
